language: python

sudo: false

cache:
  directories:
    - $HOME/.cache/pip
    - node_modules

python:
  - "3.4"

env:
  global:
    - secure: "JMpt3KkMyVBleZMavP+3zEKg/shfYKl0b9esxmPYm0HIuvufNN0nAElK5XxLzqzLiQ3DOEYoJ08W+7keEvZZTdHO1PBFhAekVdFsmYIJ5GHUNhFP8jxSY8JQ+gMeCY5V5gHcKwwiq8BlIYq/AM9a4br6nRqlGKdCP4jGFR2U/Ok=" # FEC_CF_USERNAME
    - secure: "FV08xzTfJSHyQnRpjhJLtYx1lg/FnfJwsJZYe3vu184L3a1e5D0A50PS5UmK6Uf0DhCfB6n2PwqPUpW3KKyKycTBr19b9CDAJ+mWA0EwNpyWDJLXO4DnClc/d3e6TZtzaf9jQhKUxK0DUybg7ZzUaRTcjIUroJUgV0A31MRst3I=" # FEC_CF_PASSWORD

before_install:
  - travis_retry pip install codecov
  - travis_retry curl -L -o travis_after_all.py https://raw.github.com/jmcarp/travis_after_all/master/travis_after_all.py
  - travis_retry curl -L -o cf.tgz "https://cli.run.pivotal.io/stable?release=linux64-binary&version=6.11.3&source=github-rel"
  - tar xzvf cf.tgz
  - export PATH=.:$PATH

before_script:
  - travis_retry pip install -U pip wheel
  - travis_retry pip install -r requirements.txt

  # Use production version of node.js
  - . $HOME/.nvm/nvm.sh
  - nvm install v5.5.0
  - nvm use v5.5.0

  - travis_retry npm install
  - npm run build

script:
  - py.test
  - npm run test-single

after_success:
  # Deploy to appropriate Cloud Foundry space after all builds succeed
  # See `tasks.deploy` for details
  - if [[ $TRAVIS_PULL_REQUEST = 'false' ]]; then invoke deploy --branch $TRAVIS_BRANCH --yes; fi;
  - codecov --file .coverage --file coverage/coverage.json
